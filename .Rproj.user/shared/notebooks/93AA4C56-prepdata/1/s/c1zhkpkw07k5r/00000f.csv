"0",""
"0",""
"0","library(sf)"
"0","library(rnaturalearth)"
"0","library(dplyr)"
"0",""
"0","# Get world boundaries"
"0","world <- ne_countries(scale = ""medium"", returnclass = ""sf"")"
"0",""
"0","# Initialize inferrediso2 column"
"0","lat_longs_mapbox <- lat_longs_mapbox %>%"
"0","  mutate(inferrediso2 = NA_character_)"
"0",""
"0","# Filter to only rows with valid coordinates"
"0","valid_coords <- !is.na(lat_longs_mapbox$latitude) & "
"0","                !is.na(lat_longs_mapbox$longitude)"
"0",""
"0","if(sum(valid_coords) > 0) {"
"0","  # Convert to spatial points (only valid coordinates)"
"0","  points_sf <- st_as_sf(lat_longs_mapbox[valid_coords, ], "
"0","                        coords = c(""longitude"", ""latitude""), "
"0","                        crs = 4326)"
"0","  "
"0","  # Spatial join to find which country polygon contains each point"
"0","  points_with_country <- st_join(points_sf, "
"0","                                 world %>% select(iso_a2), "
"0","                                 join = st_intersects,"
"0","                                 left = TRUE)"
"0","  "
"0","  # Extract inferrediso2"
"0","  lat_longs_mapbox$inferrediso2[valid_coords] <- points_with_country$iso_a2"
"0","  "
"0","  # Special handling for Taiwan"
"0","  # Define Taiwan's bounding box with some buffer"
"0","  taiwan_bounds <- list("
"0","    lat_min = 21.8,"
"0","    lat_max = 25.4,"
"0","    lon_min = 119.3,"
"0","    lon_max = 122.1"
"0","  )"
"0","  "
"0","  # Identify points in Taiwan region"
"0","  in_taiwan_region <- valid_coords & "
"0","                      lat_longs_mapbox$latitude >= taiwan_bounds$lat_min & "
"0","                      lat_longs_mapbox$latitude <= taiwan_bounds$lat_max & "
"0","                      lat_longs_mapbox$longitude >= taiwan_bounds$lon_min & "
"0","                      lat_longs_mapbox$longitude <= taiwan_bounds$lon_max"
"0","  "
"0","  # Override with TW for points in Taiwan region (regardless of what spatial join said)"
"0","  lat_longs_mapbox$inferrediso2[in_taiwan_region] <- ""TW"""
"0","}"
"0",""
"0",""
