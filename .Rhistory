if (Sys.info()["nodename"] == "PCACL-9RVSQ74") {
datad="C:\\Users\\rmartin7\\OneDrive - WBG\\projects\\PRINZGlobal\\imperial_college_visualization\\01_data"
localbig="C:\\Users\\rmartin7\\OneDrive - Imperial College London\\inglobe"
}
library(leaflet)
library(dplyr)
dfnew=read_parquet(paste0(localbig,"\\data\\dfnew.parquet"))
library(arrow)
dfnew=read_parquet(paste0(localbig,"\\data\\dfnew.parquet"))
df_sample <- dfnew %>% slice_sample(n = 10000)
library(data.table)
dfnew <- as.data.table(dfnew)
dt_sample <- dfnew[sample(.N, 10000)]
leaflet(dt_sample) %>%
addTiles() %>%
addCircleMarkers(
lng = ~longitude,
lat = ~latitude,
radius = 3,
fillOpacity = 0.5,
stroke = FALSE,
clusterOptions = markerClusterOptions()
)
dt_sample <- dfnew[sample(.N, 100000)]
# With clustering (much better for 100k points!)
leaflet(dt_sample) %>%
addTiles() %>%
addCircleMarkers(
lng = ~longitude,
lat = ~latitude,
radius = 3,
fillOpacity = 0.5,
stroke = FALSE,
clusterOptions = markerClusterOptions()
)
View(dt_sample)
shiny::runApp()
dataframe=df0=df %>% mutate(l=runif(n()))
dataframe=df0=df %>% mutate(l = runif(  ) )
dataframe=df0=df %>% mutate(l = runif( 1000 ) )
dataframe=df %>% mutate(l = runif( n()) )
dataframe=df %>% mutate(l =1)
library(dplyr)
library(ggplot2)
elast=function(S1,S2,rho=.1,mu=1.1){
el=-(S1 - S2*rho*mu)/((S1+S2)*(1-rho*mu)*(rho-1)+(rho-1)^2)
return(el)
}
fdf=data.frame(xS2=c(seq(0,0.45,.01),seq(.45,.5,.001))) %>% mutate(xS1=.49) %>%
mutate(el=elast(S1=xS1,S2=xS2))
fdf %>% ggplot(aes(x=xS2,y=el)) +geom_line() +
geom_smooth(method="lm")+
theme_minimal()+xlab("Energy Share")+ylab("Cross Price Elasticity")
drawdf=function(rho=.3,mu=5,nn=1000,nfac=2,sigeps=.1){
#rho=.3;mu=1.5;nn=1000;nfac=3
library(dplyr)
# Let's assume 3 production factors
# Factor 1 = labor, factor 2 energy
rS1=runif(nn,min=0.05, max=.95)
rS2=runif(nn,min=0.05, max=.95)
rS3=runif(nn,min=0.05, max=.95)
S1=rS1/(rS1+rS2+rS3)*runif(nn,min=0.05, max=.95)
S2=rS2/(rS1+rS2+rS3)*runif(nn,min=0.05, max=.95)
S3=rS3/(rS1+rS2+rS3)*runif(nn,min=0.05, max=.95)
#S=c(S1,S2,S3)
phi_ji=function(Sj,Si){
j_name <- deparse(substitute(Sj))
i_name <- deparse(substitute(Si))
phi=Sj - rho*mu* Si+(rho-1)*(j_name==i_name)
return(phi)
}
#phi_ji(S1,S2)
eps=rnorm(nn,0,sigeps)
#invphi=invphi(S,1.5,.3)
df=data.frame(S1,S2,S3,eps)
df=df %>% #rowwise() %>% mutate(delel=invphi(c(S1,S2),1.5,.3)[1,2]+eps)
#mutate(delel= rowwise() %>% mutate(delel=invphi(c(S1,S2),1.5,.3)[1,2]+eps)
mutate(
CO1=phi_ji(S2,S2)*phi_ji(S3,S3)-phi_ji(S2,S3)*phi_ji(S3,S2),
CO2=phi_ji(S2,S1)*phi_ji(S3,S3)-phi_ji(S2,S3)*phi_ji(S3,S1),
CO3=phi_ji(S2,S1)*phi_ji(S3,S2)-phi_ji(S2,S2)*phi_ji(S3,S1),
det_phi=phi_ji(S1,S1)*CO1+phi_ji(S1,S2)*CO2+phi_ji(S1,S3)*CO3,
threefac=( phi_ji(S1,S3) * phi_ji(S3,S2) -
phi_ji(S1,S2) * phi_ji(S3,S3) ) /
det_phi +
eps,
twofac=  -(S1 - S2*rho*mu)/((S1+S2)*(1-rho*mu)*(rho-1)+(rho-1)^2)+eps,
nfac_col=nfac,
delel= if_else(nfac_col==2,
twofac,
threefac
)
)
#delelf(.3,.6,rho,mu)
#df=data.frame(S1,S2,eps) %>% mutate(delel=delelf(S1,S2,rho,mu)+eps)
return(df)
}
test=drawdf(nfac=3) %>% mutate(sumS=S1+S2+S3)
library(minpack.lm)
rho =   .3
mu  =  1.5
monte1=function(){
df=drawdf(mu=mu,rho=rho, nfac=3, nn=1000, sigeps=.01)
threefac=function(S1,S2,S3,rho,mu){
phi_ji=function(Sj,Si){
j_name <- deparse(substitute(Sj))
i_name <- deparse(substitute(Si))
phi=Sj - rho*mu* Si+(rho-1)*(j_name==i_name)
return(phi)
}
CO1=phi_ji(S2,S2)*phi_ji(S3,S3)-phi_ji(S2,S3)*phi_ji(S3,S2)
CO2=phi_ji(S2,S1)*phi_ji(S3,S3)-phi_ji(S2,S3)*phi_ji(S3,S1)
CO3=phi_ji(S2,S1)*phi_ji(S3,S2)-phi_ji(S2,S2)*phi_ji(S3,S1)
det_phi=phi_ji(S1,S1) * CO1 + phi_ji(S1,S2) * CO2 + phi_ji(S1,S3) * CO3
threefac=( phi_ji(S1,S3) * phi_ji(S3,S2) - phi_ji(S1,S2) * phi_ji(S3,S3) ) /
det_phi
}
fit <- nls(delel ~ threefac(S1,S2,S3,rho,mu),
data = df,
start = list(rho =.2,  mu=2),
nls.control(maxiter = 100, warnOnly = FALSE))
# View results
summary(fit)
return(fit)
}
res=data.frame()
for(ii in 1:200){
fit <- tryCatch(monte1(), error = function(e) NULL)
if(is.null(fit)) {
rho_value <- NA
mu_value  <- NA
print("Not converged!!!")
} else {
rho_value <- coef(fit)["rho"]
mu_value <- coef(fit)["mu"]
}
coefs <- data.frame(rho_value, mu_value)
res <- bind_rows(res, coefs)
}
library(ggplot2)
res %>% ggplot(aes(x=rho_value))+geom_density()+
geom_vline(xintercept = rho,color="red")+
geom_vline(xintercept = mean(res$rho_value,na.rm=T),color="blue")
res %>% ggplot(aes(x=mu_value))+geom_density()+
geom_vline(xintercept = mu,color="red")+
geom_vline(xintercept = mean(res$mu_value,na.rm=T),color="blue")
fielddf=df %>% mutate(l =1)  runif( n()) )
df=drawdf(mu=mu,rho=rho, nfac=3, nn=1000, sigeps=.01)
fielddf= df %>% mutate(l =1)
fielddf= df %>% mutate(l =  runif( n()) )
fielddf= df %>% mutate(l =  runif( n()*1000) )
fielddf= df %>% mutate(l =  runif( n())*1000 )
df=drawdf(mu=mu,rho=rho, nfac=3, nn=1000, sigeps=.01)
fielddf= df %>% mutate(l =  runif( n())*1000, time=0 )
fielddf=fielddf %>% bindrows(fielddf %>% mutate(l =  runif( n())*1000, time=0 ), time=1)
fielddf=fielddf %>% bind_rows(fielddf %>% mutate(l =  runif( n())*1000, time=0 ), time=1)
?bind_rows
df=drawdf(mu=mu,rho=rho, nfac=3, nn=1000, sigeps=.01)
fielddf = df     %>% mutate(l =  runif( n())*1000, time=0 )
fielddf = df     %>% mutate(l =  runif( n())*1000, time=0 )
fielddf = fielddf %>% bind_rows( fielddf %>% mutate(l =l+  runif( n())*1000, time=0 ), time=1)
fielddf = df     %>% mutate(l =  runif( n())*1000, time=0 )
fielddf = fielddf %>% bind_rows( fielddf %>% mutate(l =l+ delel, time=0 , time=1 ))
View(fielddf)
fielddf %>% names()
runApp('including_subcats.R')
